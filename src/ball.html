<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Floating Ball</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');
        
        body {
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none;
        }
        html, body {
            margin: 0;
            height: 100%;
            background: transparent;
            box-shadow: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: none;
            -webkit-touch-callout: none;
            line-height: 0;
            /* box-shadow: 0 0 0px rgba(0, 0, 0, 0); */
        }

        /* ç¦ç”¨æ‰€æœ‰é€‰æ‹©é«˜äº® */
        ::selection {
            background: transparent;
            color: inherit;
        }

        ::-moz-selection {
            background: transparent;
            color: inherit;
        }

        #ball-container {
            width: 100px;
            height: 100px;
            position: relative;
            cursor: grab;
            box-shadow: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
            margin: 0;
            padding: 0;
            border: none;
        }

        #ball {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff9a6b, #ff6b6b);
            cursor: grab;
            transition: transform 0.1s ease-out;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: visible;
            margin: 0;
            padding: 0;
            border: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
        }

        #ball.dragging {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(0.95) !important;
        }

        #ball::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 50%);
            border-radius: 50%;
            pointer-events: none;
        }

        #ball-icon {
            position: relative;
            z-index: 2;
            transition: opacity 0.3s ease;
            display: inline-block;
        }

        /* å¤ªé˜³æ—‹è½¬ä¸è„‰å†²åŠ¨ç”» */
        #ball-icon.sun-icon {
            animation: sun-spin 20s linear infinite, sun-pulse 3s ease-in-out infinite;
        }

        @keyframes sun-spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes sun-pulse {
            0%, 100% {
                filter: drop-shadow(0 0 0px rgba(255, 200, 0, 0.8));
            }
            50% {
                filter: drop-shadow(0 0 8px rgba(255, 200, 0, 1));
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.5);
            }
            50% {
                box-shadow: 0 0 0 12px rgba(255, 107, 107, 0);
            }
        }

        #ball.active {
            animation: rotate 3s linear infinite !important;
        }

        #ball.recording {
            animation: pulse 0.8s cubic-bezier(0.4, 0, 0.6, 1) infinite !important;
        }

        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* æ¶Ÿæ¼ªå±‚ */
        #ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid rgba(255, 107, 107, 0.6);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        @keyframes ripple-expand {
            0% {
                width: 60px;
                height: 60px;
                border-color: rgba(255, 107, 107, 0.8);
                opacity: 1;
            }
            100% {
                width: 120px;
                height: 120px;
                border-color: rgba(255, 107, 107, 0);
                opacity: 0;
            }
        }

        #ripple.active {
            animation: ripple-expand 0.6s ease-out;
        }

        #stats {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 9px;
            color: #fff;
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 3px;
            border-radius: 2px;
            font-family: monospace;
            line-height: 1;
            text-align: right;
            width: 22px;
            z-index: 3;
        }

        #ball.day {
            background: radial-gradient(circle at 30% 30%, #ffeb3b, #ffc107);
        }

        #ball.night {
            background: radial-gradient(circle at 30% 30%, #424242, #1a1a1a);
            color: #fff;
        }

        #ball.dusk {
            background: radial-gradient(circle at 30% 30%, #ff7043, #e64a19);
        }

        /* è£…é¥°å…ƒç´  */
        #decorations {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 0;
        }

        .decoration {
            position: absolute;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
            visibility: hidden;
        }

        .decoration.show {
            opacity: 0.8;
            visibility: visible;
        }

        /* äº‘æœµè£…é¥° - ä¸€åŠåœ¨çƒå†…ï¼Œä¸€åŠåœ¨çƒå¤–ï¼Œä¸å—floatåŠ¨ç”»å½±å“ */
        .cloud {
            font-size: 30px;
            top: 22px;
            left: 70%;
            margin-left: -18px;
            z-index: 2;
            /* é˜²æ­¢floatå’Œå…¶ä»–åŠ¨ç”»è¦†ç›–å®šä½ */
        }
        
        .cloud.float {
            animation: none !important;
        }

        /* æ˜Ÿæ˜Ÿè£…é¥° - ä¸€åŠåœ¨çƒå†…ï¼Œä¸€åŠåœ¨çƒå¤– */
        @keyframes twinkle {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.9; }
        }

        .star {
            font-size: 24px;
            z-index: 0;
        }
        
        .star.show {
            animation: twinkle 2s infinite;
        }

        .star-1 {
            top: 8px;
            left: 8px;
        }

        .star-2 {
            top: 8px;
            right: 8px;
        }

        .star-3 {
            bottom: 8px;
            left: 8px;
        }

        .star-4 {
            bottom: 8px;
            right: 8px;
        }

        /* æœˆå…‰å…‰æ™• */
        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(200, 200, 255, 0.3) inset;
            }
            50% { 
                box-shadow: 0 0 15px rgba(200, 200, 255, 0.6) inset;
            }
        }

        #ball.night {
            animation: glow 3s ease-in-out infinite;
        }

        /* é£å¹åŠ¨ç”» */
        @keyframes float {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(2px); }
        }

        .decoration.float {
            animation: float 2s ease-in-out infinite;
        }

        /* å·¥ä½œåŠ¨ç”» */
        @keyframes work-bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        #ball.working .decoration {
            animation: work-bounce 0.8s ease-in-out infinite;
        }

    </style>
</head>
<body>
<div id="ball-container" draggable="false">
    <div id="ball" draggable="false" style="image-rendering: pixelated; touch-action: none;">
        <div id="ball-icon">â˜€ï¸</div>
        <div id="stats">CPU RAM</div>
    </div>
    <div id="ripple"></div>
    <div id="decorations">
        <div class="decoration cloud" id="cloud">â˜ï¸</div>
        <div class="decoration star star-1" id="star-1">â­</div>
        <div class="decoration star star-2" id="star-2">âœ¨</div>
        <div class="decoration star star-3" id="star-3">â­</div>
        <div class="decoration star star-4" id="star-4">âœ¨</div>
    </div>
</div>

<script type="module">
    const ball = document.getElementById('ball');
    const ballIcon = document.getElementById('ball-icon');
    const statsDiv = document.getElementById('stats');
    const ripple = document.getElementById('ripple');
    const cloudDeco = document.getElementById('cloud');
    const starDecos = [document.getElementById('star-2')]; // åªç•™ä¸€ä¸ªâœ¨è£…é¥°
    
    let isBegin = false;
    let isLongPressActive = false; 
    
    // æ‹–åŠ¨å®ç°
    let dragging = false;
    let hasMoved = false;
    let longPressTimer = null;
    let startX = 0, startY = 0;
    let windowStartX = 0, windowStartY = 0;
    let mouseDownTime = 0;

    // ===== å…¨å±€äº‹ä»¶ç¦ç”¨ =====
    // ç¦æ­¢æ‰€æœ‰å½¢å¼çš„æ–‡æœ¬é€‰æ‹©å’Œæ‹–åŠ¨åé¦ˆ
    document.addEventListener('selectstart', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });

    document.addEventListener('mousedown', (e) => {
        if (e.detail > 1) { // å¤šå‡»
            e.preventDefault();
            return false;
        }
    }, { capture: true });

    document.addEventListener('mousemove', (e) => {
        // ç¦æ­¢ç”Ÿæˆé€‰æ‹©æ‹–æ‹½åé¦ˆ
    }, { capture: true });

    document.addEventListener('dragstart', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });

    document.addEventListener('drag', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });

    // ç¦ç”¨æ–‡æœ¬é€‰æ‹©çš„CSS cursor
    document.body.style.WebkitUserSelect = 'none';
    document.body.style.MozUserSelect = 'none';
    document.body.style.msUserSelect = 'none';
    document.body.style.userSelect = 'none';
    
    // ===== æ¶Ÿæ¼ªæ•ˆæœ =====
    const playRipple = () => {
        ripple.classList.remove('active');
        // å¼ºåˆ¶é‡æ’ä»¥é‡æ–°è§¦å‘åŠ¨ç”»
        void ripple.offsetWidth;
        ripple.classList.add('active');
    };

    // è·å–æ—¶é—´æ®µå¹¶æ›´æ–°å¤–è§‚åŠè£…é¥°
    const updateTimeTheme = () => {
        const hour = new Date().getHours();
        // const hour = 21; // æµ‹è¯•ç”¨å›ºå®šæ—¶é—´
        
        // éšè—æ‰€æœ‰è£…é¥°
        cloudDeco.classList.remove('show', 'float');
        starDecos.forEach(star => star.classList.remove('show'));
        
        if (hour >= 6 && hour < 12) {
            // æ—©ä¸Šï¼šé»„è‰²å¤ªé˜³ + äº‘æœµ
            ball.className = 'day';
            ballIcon.textContent = 'ğŸŒ…';
            cloudDeco.classList.add('show', 'float');
            cloudDeco.textContent = 'â˜ï¸';
        } else if (hour >= 12 && hour < 17) {
            // ä¸­åˆåˆ°ä¸‹åˆï¼šæ˜äº®å¤ªé˜³ + äº‘æœµ
            ball.className = 'day';
            ballIcon.textContent = 'â˜€ï¸';
            ballIcon.classList.add('sun-icon'); // æ·»åŠ å¤ªé˜³åŠ¨ç”»ç±»
            cloudDeco.classList.add('show', 'float');
            cloudDeco.textContent = 'â˜ï¸';
        } else if (hour >= 17 && hour < 20) {
            // å‚æ™šï¼šè½æ—¥ + äº‘æœµ
            ball.className = 'dusk';
            ballIcon.textContent = 'ğŸŒ…';
            cloudDeco.classList.add('show', 'float');
            cloudDeco.textContent = 'ğŸŒ§ï¸';
        } else {
            // æ™šä¸Šï¼šæœˆäº® + æ˜Ÿæ˜Ÿ
            ball.className = 'night';
            ballIcon.textContent = hour >= 20 && hour < 23 ? 'ğŸŒ™' : 'â­';
            cloudDeco.classList.add('show');
            cloudDeco.textContent = 'â˜ï¸';
            starDecos.forEach(star => star.classList.add('show'));
        }
    };

    // è·å–ç³»ç»ŸCPUå’ŒRAMå ç”¨
    const updateStats = async () => {
        try {
            const stats = await window.electronAPI.getSystemStats?.();
            if (stats) {
                statsDiv.innerHTML = `${stats.cpu}<br/>${stats.ram}`;
            }
        } catch (error) {
            console.error('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
        }
    };

    // åˆå§‹åŒ–å’Œå®šæ—¶æ›´æ–°
    // åˆå§‹æ—¶éšè—æ‰€æœ‰è£…é¥°
    cloudDeco.classList.remove('show', 'float');
    starDecos.forEach(star => star.classList.remove('show'));
    
    updateTimeTheme();
    updateStats();
    setInterval(updateTimeTheme, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ä¸»é¢˜
    setInterval(updateStats, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡ç³»ç»Ÿä¿¡æ¯

    // è§†è§‰åé¦ˆå‡½æ•°
    const setBallState = (type) => {
        // å…ˆç§»é™¤æ‰€æœ‰åŠ¨ç”»ç±»
        ball.classList.remove('active', 'recording', 'working', 'dragging');
        
        if (type === 'recording') {
            ball.classList.add('recording');
            starDecos.forEach(star => star.classList.remove('show'));
        } else if (type === 'active') {
            starDecos.forEach(star => star.classList.remove('show'));
        } else {
            updateTimeTheme(); // æ¢å¤æ—¶é—´ä¸»é¢˜
        }
    };
    
    ball.addEventListener('mousedown', (e) => {
        console.log("æ‚¬æµ®çª—å·¦é”®ç‚¹å‡»")
        if (e.button !== 0) return;
        
        ball.classList.add('dragging');
        playRipple(); // è§¦å‘æ¶Ÿæ¼ªæ•ˆæœ
        
        dragging = true;
        startX = e.screenX;
        startY = e.screenY;
        hasMoved = false;
        mouseDownTime = Date.now();
        
        window.electronAPI.getWindowPosition()
            .then(pos => {
                windowStartX = pos.x;
                windowStartY = pos.y;
            })
            .catch(err => {
                console.error('è·å–çª—å£ä½ç½®å¤±è´¥:', err);
            });

        longPressTimer = setTimeout(() => {
            if (!hasMoved && dragging) {
                playRipple(); // è§¦å‘æ¶Ÿæ¼ªæ•ˆæœ
                isLongPressActive = true;
                console.log("è§¦å‘é•¿æŒ‰ï¼šå¼€å§‹å½•éŸ³");
                window.electronAPI.QuickListen(true, true);
                setBallState('recording');
            }
        }, 250);
        
        e.preventDefault();
        e.stopPropagation();
    });
    
    window.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        
        const deltaX = e.screenX - startX;
        const deltaY = e.screenY - startY;
        
        // ä½ç§»è¶…è¿‡ 5 åƒç´ åˆ¤å®šä¸ºç§»åŠ¨
        if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
            // å…³é”®ä¿®æ”¹ï¼šåªæœ‰åœ¨è¿˜æœªå¼€å§‹é•¿æŒ‰å½•éŸ³æ—¶æ‰ä¸­æ–­
            if (!hasMoved && !isLongPressActive) {
                hasMoved = true;
                clearTimeout(longPressTimer); // ç§»åŠ¨äº†ï¼Œå–æ¶ˆé•¿æŒ‰åˆ¤å®š
                console.log("æ£€æµ‹åˆ°ç§»åŠ¨ï¼Œå–æ¶ˆé•¿æŒ‰åˆ¤å®š");
            }
            
            window.electronAPI.dragWindow({
                x: windowStartX + deltaX,
                y: windowStartY + deltaY
            });
        }
    });
    
    window.addEventListener('mouseup', () => {
        if (!dragging) return;
        
        ball.classList.remove('dragging');
        const clickDuration = Date.now() - mouseDownTime;
        clearTimeout(longPressTimer);

        if (isLongPressActive) {
            // å½•éŸ³æœ€çŸ­æ—¶é—´é™åˆ¶ 500ms
            if (clickDuration >= 500) {
                console.log("é•¿æŒ‰ç»“æŸï¼šåœæ­¢å½•éŸ³ï¼ŒæŒ‰å‹æ—¶é•¿ ", clickDuration, "ms");
                window.electronAPI.QuickListen(true, false);
                isLongPressActive = false;
                setBallState(isBegin ? 'active' : 'default');
            } else {
                console.log("é•¿æŒ‰æ—¶é—´è¿‡çŸ­ " + clickDuration + "msï¼Œå–æ¶ˆå½•éŸ³");
                // ç›´æ¥å–æ¶ˆï¼Œä¸å‘é€
                window.electronAPI.QuickListen(false, false); // å–æ¶ˆ
                isLongPressActive = false;
                setBallState(isBegin ? 'active' : 'default');
            }
        } 
        else if (!hasMoved && clickDuration < 200) {
            console.log("è§¦å‘å•å‡»ï¼šåˆ‡æ¢ä¸»çª—å£");
            playRipple(); // è§¦å‘æ¶Ÿæ¼ªæ•ˆæœ
            window.electronAPI.toggleMainWindow();
        }

        dragging = false;
    });
    
    // åŒå‡»äº‹ä»¶
    ball.addEventListener('dblclick', (e) => {
        playRipple(); // è§¦å‘æ¶Ÿæ¼ªæ•ˆæœ
        isBegin = !isBegin;
        console.log('è§¦å‘åŒå‡»ï¼ŒçŠ¶æ€:', isBegin ? 'å¼€å§‹' : 'åœæ­¢');
        window.electronAPI.QuickListen(false, isBegin);
        setBallState(isBegin ? 'active' : 'default');
    });
    
    // é˜²æ­¢æ–‡æœ¬é€‰ä¸­å’Œé€‰æ‹©
    document.addEventListener('selectstart', (e) => {
        e.preventDefault();
        return false;
    });

    ball.addEventListener('selectstart', (e) => {
        e.preventDefault();
        return false;
    });
    
    // // ç¦ç”¨åŒå‡»é€‰æ‹©
    // document.addEventListener('dblclick', (e) => {
    //     if (e.target === ball || ball.contains(e.target)) {
    //         e.preventDefault();
    //         return false;
    //     }
    // }, { capture: true });

    // // ç¦ç”¨æ‹–åŠ¨äº‹ä»¶
    // ball.addEventListener('dragstart', (e) => {
    //     e.preventDefault();
    //     return false;
    // });

    // // ç¦ç”¨ä¸Šä¸‹æ–‡èœå•
    // ball.addEventListener('contextmenu', (e) => {
    //     e.preventDefault();
    //     return false;
    // });

    // // ç¦ç”¨è§¦æ‘¸é€‰æ‹©
    // document.addEventListener('touchmove', (e) => {
    //     if (e.target === ball || ball.contains(e.target)) {
    //         e.preventDefault();
    //         return false;
    //     }
    // }, { passive: false });

    // // ç¦ç”¨mouseupå¯¼è‡´çš„é€‰æ‹©
    // document.addEventListener('mouseup', (e) => {
    //     if (e.target === ball || ball.contains(e.target)) {
    //         // æ¸…ç©ºä»»ä½•å¯èƒ½çš„é€‰æ‹©
    //         if (window.getSelection) {
    //             window.getSelection().removeAllRanges();
    //         }
    //     }
    // });
</script>
</body>
</html>