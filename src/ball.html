<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Floating Ball</title>
    <style>
        html, body {
            margin: 0;
            height: 100%;
            background: transparent;
            /* box-shadow: 0 0 0px rgba(0, 0, 0, 0); */
        }

        #ball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff9a6b, #ff6b6b);
            /* box-shadow: 0 0 0px rgba(0, 0, 0, 0); */
            cursor: grab;
            transition: transform 0.15s;
        }

        #ball:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

    </style>
</head>
<body>
<div id="ball"></div>

<script type="module">
    const ball = document.getElementById('ball');
    let isBegin = false;
    let isLongPressActive = false; 
    
    // 拖动实现
    let dragging = false;
    let hasMoved = false; // 是否触发了位移
    let longPressTimer = null; // 长按计时器
    let startX = 0, startY = 0;
    let windowStartX = 0, windowStartY = 0;
    let mouseDownTime = 0;

    // 视觉反馈函数
    const setBallColor = (type) => {
        if (type === 'recording') {
            ball.style.background = 'radial-gradient(circle at 30% 30%, #ff4b4b, #c0392b)'; // 录音中：深红
        } else if (type === 'active') {
            ball.style.background = 'radial-gradient(circle at 30% 30%, #6bff9a, #2ecc71)'; // 双击开启：绿色
        } else {
            ball.style.background = 'radial-gradient(circle at 30% 30%, #ff9a6b, #ff6b6b)'; // 默认：橙红
        }
    };
    
    ball.addEventListener('mousedown', (e) => {
        console.log("悬浮窗左键点击")
        if (e.button !== 0) return; // 只响应左键
        
        dragging = true;
        startX = e.screenX;
        startY = e.screenY;
        hasMoved = false;
        mouseDownTime = Date.now();
        
        // 获取当前窗口位置
        window.electronAPI.getWindowPosition()
            .then(pos => {
                windowStartX = pos.x;
                windowStartY = pos.y;
            })
            .catch(err => {
                console.error('获取窗口位置失败:', err);
            });

        // 250ms 后判定为长按
        longPressTimer = setTimeout(() => {
            if (!hasMoved && dragging) {
                isLongPressActive = true;
                console.log("触发长按：开始录音");
                window.electronAPI.Listen(true, true); // 参数1: isLongPress=true, 参数2: isBegin=true
                setBallColor('recording');
            }
        }, 250);
        
        // 防止默认行为
        e.preventDefault();
        e.stopPropagation();
        
        // 添加一个临时类来改变鼠标样式
        ball.classList.add('dragging');
    });
    
    window.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        
        const deltaX = e.screenX - startX;
        const deltaY = e.screenY - startY;
        
        // 位移超过 5 像素判定为移动
        if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
            if (!hasMoved) {
                hasMoved = true;
                clearTimeout(longPressTimer); // 移动了，取消长按判定
                console.log("检测到移动，取消长按判定");
            }
            
            window.electronAPI.dragWindow({
                x: windowStartX + deltaX,
                y: windowStartY + deltaY
            });
        }
    });
    
    window.addEventListener('mouseup', () => {
        if (!dragging) return;
        
        const clickDuration = Date.now() - mouseDownTime;
        clearTimeout(longPressTimer); // 抬起时必须清除计时器

        if (isLongPressActive) {
            // 如果刚才处于长按录音状态，抬起即停止
            console.log("长按结束：停止录音");
            // window.electronAPI.Listen(true, false); // 发送停止指令
            isLongPressActive = false;
            setBallColor(isBegin ? 'active' : 'default'); // 恢复颜色
        } 
        else if (!hasMoved && clickDuration < 200) {
            // 只有没移动过且时间短，才视为单击（切换窗口）
            console.log("触发单击：切换主窗口");
            window.electronAPI.toggleMainWindow();
        }

        dragging = false;
    });
    
    // 双击事件
    ball.addEventListener('dblclick', (e) => {
        isBegin = !isBegin;
        console.log('触发双击，状态:', isBegin ? '开始' : '停止');
        window.electronAPI.Begin(false, isBegin);
        setBallColor(isBegin ? 'active' : 'default');
    });
    
    // 防止文本选中
    ball.addEventListener('selectstart', (e) => {
        e.preventDefault();
    });
</script>
</body>
</html>