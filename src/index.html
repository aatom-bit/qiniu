<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Linux AI åŠ©æ‰‹</title>
    <style>
        /* æ ·å¼ä¿æŒä¸ä¹‹å‰å»ºè®®çš„æš—é»‘é£æ ¼ä¸€è‡´ */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #ccc; }
        .app-container { display: flex; height: 100vh; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 220px; background: #252526; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .new-chat-btn { padding: 15px; margin: 10px; background: #333; text-align: center; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        .new-chat-btn:hover { background: #444; }
        .history-list { flex: 1; overflow-y: auto; }
        .history-item { padding: 12px 15px; font-size: 13px; border-bottom: 1px solid #2d2d2d; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item.active { background: #37373d; border-left: 3px solid #007acc; }

        /* å¯¹è¯åŒº */
        .main-chat { flex: 1; display: flex; flex-direction: column; }
        #messages-container { flex: 1; overflow-y: auto; padding: 20px; }
        
        .message { display: flex; margin-bottom: 20px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .message.user { flex-direction: row-reverse; }
        .avatar { font-size: 20px; margin: 0 12px; }
        .content { max-width: 80%; }
        .text-bubble { background: #333; padding: 10px 14px; border-radius: 8px; line-height: 1.5; word-wrap: break-word; }
        .user .text-bubble { background: #007acc; color: white; }

        /* ä»£ç å—æ ·å¼ */
        .code-block { background: #000; border-radius: 6px; margin-top: 8px; border: 1px solid #444; }
        .code-header { background: #333; padding: 5px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
        .code-header button { background: #28a745; border: none; color: white; padding: 3px 8px; border-radius: 3px; cursor: pointer; }
        pre { padding: 12px; margin: 0; font-family: 'Fira Code', 'Courier New', monospace; overflow-x: auto; font-size: 13px; color: #d7ba7d; }

        /* è¾“å…¥åŒº */
        .input-area { padding: 20px; border-top: 1px solid #333; display: flex; gap: 10px; }
        #user-input { flex: 1; height: 50px; background: #2d2d2d; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; resize: none; outline: none; }
        #send-btn { width: 80px; background: #007acc; border: none; color: white; border-radius: 4px; cursor: pointer; }
        #send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ... ä¿æŒåŸæœ‰æ ·å¼ï¼Œæ·»åŠ  action-btn æ ·å¼ ... */
        .action-btn { 
            padding: 12px; 
            margin: 5px 10px; 
            background: #2d2d2d; 
            color: #aaa;
            text-align: center; 
            border: 1px solid #444;
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 13px;
            transition: 0.2s; 
        }
        .action-btn:hover { background: #3d3d3d; color: #fff; }
        .action-btn.active { border-color: #ff9a6b; color: #ff9a6b; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="new-chat-btn" id="new-chat-btn">+ æ–°å¯¹è¯</div>
        <!-- æ˜¾ç¤º/å…³é—­æ‚¬æµ®çƒæŒ‰é’® -->
        <div class="action-btn" id="toggle-ball-btn">æ˜¾ç¤ºæ‚¬æµ®çƒ</div>

        <div class="history-list" id="history-list"></div>
    </div>
    <div class="main-chat">
        <div id="messages-container"></div>
        <div class="input-area">
            <textarea id="user-input" placeholder="è¾“å…¥æŒ‡ä»¤æˆ–æé—®..."></textarea>
            <button id="send-btn">å‘é€</button>
        </div>
    </div>
</div>

<script>
    // æ¨¡æ‹Ÿ Vue çš„å“åº”å¼æ•°æ®
    let state = {
        history: [],
        currentSessionIndex: 0,
        loading: false
    };

    const msgContainer = document.getElementById('messages-container');
    const historyListEl = document.getElementById('history-list');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // 1. åˆå§‹åŒ–
    async function init() {
        state.history = await window.electronAPI.getHistory();
        if (state.history.length === 0) {
            createNewChat();
        }
        renderHistory();
        renderMessages();
    }

    // 2. æ¸²æŸ“å†å²è®°å½•ä¾§è¾¹æ 
    function renderHistory() {
        historyListEl.innerHTML = '';
        state.history.forEach((session, index) => {
            const div = document.createElement('div');
            div.className = `history-item ${state.currentSessionIndex === index ? 'active' : ''}`;
            div.innerText = session.title || 'æ–°ä¼šè¯ ' + (index + 1);
            div.onclick = () => switchSession(index);
            historyListEl.appendChild(div);
        });
    }

    // 3. æ¸²æŸ“å½“å‰ä¼šè¯çš„æ¶ˆæ¯
    function renderMessages() {
        msgContainer.innerHTML = '';
        const messages = state.history[state.currentSessionIndex]?.messages || [];
        messages.forEach(msg => appendMessageUI(msg.role, msg.content));
        scrollToBottom();
    }

    // 4. å°†å•æ¡æ¶ˆæ¯æ·»åŠ åˆ° UI
    function appendMessageUI(role, content) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;
        
        const isCode = content.includes('```');
        const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

        let innerHTML = `
            <div class="avatar">${avatar}</div>
            <div class="content">
        `;

        if (isCode) {
            // æå–ä»£ç é€»è¾‘ (æ­£åˆ™è¡¨è¾¾å¼)
            const code = content.replace(/```(sh|bash|shell)?/gi, '').replace(/```/g, '').trim();
            innerHTML += `
                <div class="code-block">
                    <div class="code-header">
                        <span>Shell Script</span>
                        <button onclick="executeScript(\`${code.replace(/`/g, '\\`')}\`)">âš¡ æ‰§è¡Œ</button>
                    </div>
                    <pre><code>${code}</code></pre>
                </div>
            `;
        } else {
            innerHTML += `<div class="text-bubble">${content}</div>`;
        }

        innerHTML += `</div>`;
        msgDiv.innerHTML = innerHTML;
        msgContainer.appendChild(msgDiv);
        scrollToBottom();
    }

    // 5. äº¤äº’åŠŸèƒ½
    async function send() {
        const text = userInput.value.trim();
        if (!text || state.loading) return;

        state.loading = true;
        sendBtn.disabled = true;
        
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        state.history[state.currentSessionIndex].messages.push({ role: 'user', content: text });
        appendMessageUI('user', text);
        userInput.value = '';

        // è°ƒç”¨è¯†åˆ«ç”¨æˆ·éœ€æ±‚å¹¶è‡ªåŠ¨æ‰§è¡Œshellï¼Œè¿”å›æ‰§è¡Œæƒ…å†µ 
        // TODO:æµ‹è¯•å®Œæˆæ—¶å–æ¶ˆä»¥ä¸‹æ³¨é‡Š
        const response = await window.electronAPI.sendMessage({
            text: text,
            sessionId: state.currentSessionIndex,
            sessionCount: state.history.length
        });
        // æ›´æ–°åŠ©æ‰‹å›å¤
        state.history[state.currentSessionIndex].messages.push({ role: 'assistant', content: response });
        appendMessageUI('assistant', response);

        // å¦‚æœæ˜¯é¦–æ¡æ¶ˆæ¯ï¼Œæ›´æ–°æ ‡é¢˜
        if (state.history[state.currentSessionIndex].messages.length === 1) {
            state.history[state.currentSessionIndex].title = text.length > 5 ? `${text.substring(0, 5)}...` : text;
            renderHistory();
        }

        state.loading = false;
        sendBtn.disabled = false;
    }

    function createNewChat() {
        state.history.unshift({ title: 'æ–°ä¼šè¯', messages: [] });
        state.currentSessionIndex = 0;
        renderHistory();
        renderMessages();
    }

    function switchSession(index) {
        if (index < state.history.length && index >= 0) {
            state.currentSessionIndex = index;
            renderHistory();
            renderMessages();

            // è®©åç«¯æ›´æ–°sessionId
            window.electronAPI.sessionSwitch(index);
        } else {
            console.log(`index: ${index}, out of range!`);
        }
    }

    window.executeScript = async (code) => {
        if (confirm("ç¡®è®¤æ‰§è¡Œæ­¤è„šæœ¬ï¼Ÿ\n\n" + code)) {
            await window.electronAPI.runCommand(code);
        }
    };

    function scrollToBottom() {
        msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('new-chat-btn').onclick = createNewChat;
    sendBtn.onclick = send;
    userInput.onkeyup = (e) => { if (e.key === 'Enter') send(); };

    // // ç›‘å¬æ¥è‡ªè¯­éŸ³è¯†åˆ«çš„ç»“æœå¹¶å¡«å…¥è¾“å…¥æ¡†
    // window.electronAPI.onUpdateStatus((event, data) => {
    //     if (data.role === 'user') {
    //         userInput.value = data.content;
    //         send(); // è‡ªåŠ¨å‘é€è¯­éŸ³è¯†åˆ«çš„å†…å®¹
    //     }
    // });

     const toggleBallBtn = document.getElementById('toggle-ball-btn');
    let isBallShowing = false;

    // ç‚¹å‡»åˆ‡æ¢æ‚¬æµ®çƒæ˜¾ç¤º
    toggleBallBtn.onclick = () => {
        isBallShowing = !isBallShowing;
        window.electronAPI.toggleBall(isBallShowing);
        updateBallBtnUI(isBallShowing);
    };

    // ç›‘å¬æ¥è‡ªä¸»è¿›ç¨‹çš„æ‚¬æµ®çƒçŠ¶æ€æ›´æ–° (ä¾‹å¦‚æ‚¬æµ®çƒè¢«è‡ªå·±å…³é—­äº†)
    window.electronAPI.onBallStatus((exists) => {
        isBallShowing = exists;
        updateBallBtnUI(exists);
    });

    function updateBallBtnUI(exists) {
        if (exists) {
            toggleBallBtn.innerText = 'å…³é—­æ‚¬æµ®çƒ';
            toggleBallBtn.classList.add('active');
        } else {
            toggleBallBtn.innerText = 'æ˜¾ç¤ºæ‚¬æµ®çƒ';
            toggleBallBtn.classList.remove('active');
        }
    }

    // å“åº”aiè¿”å›
    window.electronAPI.onAiResponse(({ role, content }) => {
        // è°ƒç”¨ä¹‹å‰å†™çš„æ·»åŠ æ¶ˆæ¯ UI çš„å‡½æ•°
        appendMessageUI(role, content);
        
        // å¦‚æœæ ‡é¢˜å¯èƒ½å˜äº†ï¼Œåˆ·æ–°ä¾§è¾¹æ æ ‡é¢˜
        renderHistory();
    });

    init();
</script>
</body>
</html>
